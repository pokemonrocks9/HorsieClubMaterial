<!-- Fixed full version based on original index (3) file, preserving visuals and full functionality -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Horsie Picker</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
<style>
:root {
  --primary: #ff4081;
  --secondary: #03dac6;
  --surface: #1e1e1e;
  --background: #121212;
  --text: #ffffff;
  --error: #cf6679;
  --radius: 10px;
}

body {
  margin: 0;
  font-family: 'Roboto', sans-serif;
  background-color: var(--background);
  color: var(--text);
  overflow-x: hidden;
}

header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem 2rem;
  background-color: var(--surface);
  box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

h1 {
  color: var(--primary);
  margin: 0;
}

button {
  background-color: var(--primary);
  color: var(--text);
  border: none;
  border-radius: var(--radius);
  padding: 0.6rem 1.2rem;
  font-size: 1rem;
  cursor: pointer;
  transition: background-color 0.3s;
}
button:hover { background-color: #e91e63; }
button:disabled { opacity: 0.5; cursor: not-allowed; }

section {
  background-color: var(--surface);
  margin: 1rem auto;
  padding: 1rem 2rem;
  border-radius: var(--radius);
  max-width: 900px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

.hidden { display: none; }

.card-list {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  margin-top: 0.5rem;
}
.card-list div {
  background-color: #2a2a2a;
  padding: 0.8rem 1rem;
  border-radius: var(--radius);
  cursor: pointer;
  transition: background-color 0.2s, transform 0.2s;
}
.card-list div:hover {
  background-color: #333;
  transform: translateY(-2px);
}

.selected {
  background-color: var(--primary) !important;
  color: #fff;
}

input[type="text"] {
  width: 100%;
  padding: 0.6rem;
  margin: 0.4rem 0;
  border-radius: var(--radius);
  border: 1px solid #444;
  background: #2a2a2a;
  color: var(--text);
}
input[type="text"]:focus {
  outline: 2px solid var(--secondary);
}

footer {
  text-align: center;
  padding: 1rem;
  color: var(--secondary);
  font-size: 0.9rem;
}
</style>
</head>
<body>
<header>
  <h1>üèá Horsie Picker</h1>
  <button id="homeBtn" class="hidden" onclick="goHome()">üè† Home</button>
</header>

<section id="setup">
  <h2>Setup Session</h2>
  <input id="username" type="text" placeholder="Your Name">
  <input id="sessionCode" type="text" placeholder="Session Code">
  <button onclick="startSession()">Start Session</button>
  <div style="margin-top: 1rem;">
    <button onclick="refreshSessions()">Refresh Sessions</button>
    <button style="background-color: var(--error);" onclick="clearAllSessions()">Clear All</button>
  </div>
  <div id="sessionList" style="margin-top: 1rem;">Loading...</div>
</section>

<section id="dateSelector" class="hidden">
  <h2>Select Date</h2>
  <div class="card-list" id="dateList"></div>
</section>

<section id="trackSelector" class="hidden">
  <button onclick="backToDateSelector()">‚Üê Back</button>
  <h2>Select Track</h2>
  <div class="card-list" id="trackList"></div>
</section>

<section id="raceSelector" class="hidden">
  <button onclick="backToTrackSelector()">‚Üê Back</button>
  <h2>Select Race</h2>
  <div class="card-list" id="raceList"></div>
</section>

<section id="raceDetail" class="hidden">
  <button onclick="backToRaceSelector()">‚Üê Back</button>
  <h2 id="raceTitle"></h2>
  <div id="raceInfo"></div>
  <div class="card-list" id="horseList"></div>
  <button id="savePicksBtn" onclick="savePicks()" disabled>üíæ Save Picks</button>
</section>

<footer>Horsie Picker ¬© 2025</footer>

<script>
const API = 'https://horsie.tytygoins.workers.dev';
const RACES = 'https://raw.githubusercontent.com/pokemonrocks9/HorsieClub/main/races.json';
let S = '', U = '', races = [], R = null, P = new Set(), D = '', T = '';

async function startSession() {
  U = document.getElementById('username').value.trim();
  S = document.getElementById('sessionCode').value.trim();
  if (!U || !S) {
    alert('Please enter both name and code');
    return;
  }
  document.getElementById('setup').classList.add('hidden');
  document.getElementById('homeBtn').classList.remove('hidden');
  await loadRaces();
  showDateSelector();
}

async function loadRaces() {
  try {
    const res = await fetch(RACES);
    races = await res.json();
  } catch (e) {
    alert('Failed to load races: ' + e.message);
  }
}

async function refreshSessions() {
  const el = document.getElementById('sessionList');
  el.innerHTML = 'Loading...';
  try {
    const res = await fetch(`${API}/picks/sessions`);
    if (!res.ok) throw new Error('API error');
    const data = await res.json();
    el.innerHTML = data.length ? data.map(d => `<div>${d.session_code}</div>`).join('') : 'No active sessions';
  } catch (e) {
    el.innerHTML = 'Failed to load sessions';
  }
}

async function clearAllSessions() {
  if (!confirm('‚ö†Ô∏è Delete ALL sessions?')) return;
  try {
    const res = await fetch(`${API}/picks/all`, { method: 'DELETE' });
    if (res.ok) {
      alert('‚úÖ Cleared all');
      refreshSessions();
    }
  } catch (e) {
    alert(e.message);
  }
}

function showDateSelector() {
  if (!races || !races.length) return;
  const byDate = {};
  races.forEach(r => {
    if (!byDate[r.date]) byDate[r.date] = [];
    byDate[r.date].push(r);
  });
  const list = document.getElementById('dateList');
  list.innerHTML = '';
  Object.keys(byDate).forEach(d => {
    const el = document.createElement('div');
    el.textContent = `${d} (${byDate[d].length} races)`;
    el.onclick = () => selectDate(d);
    list.appendChild(el);
  });
  document.getElementById('dateSelector').classList.remove('hidden');
}

function selectDate(d) {
  D = d;
  document.getElementById('dateSelector').classList.add('hidden');
  showTrackSelector();
}

function showTrackSelector() {
  const list = document.getElementById('trackList');
  list.innerHTML = '';
  const byTrack = {};
  races.filter(r => r.date === D).forEach(r => {
    if (!byTrack[r.track]) byTrack[r.track] = [];
    byTrack[r.track].push(r);
  });
  Object.keys(byTrack).forEach(t => {
    const el = document.createElement('div');
    el.textContent = `${t} (${byTrack[t].length})`;
    el.onclick = () => selectTrack(t);
    list.appendChild(el);
  });
  document.getElementById('trackSelector').classList.remove('hidden');
}

function selectTrack(t) {
  T = t;
  document.getElementById('trackSelector').classList.add('hidden');
  showRaceSelector();
}

function showRaceSelector() {
  const list = document.getElementById('raceList');
  list.innerHTML = '';
  const rs = races.filter(r => r.date === D && r.track === T);
  rs.forEach(r => {
    const el = document.createElement('div');
    el.textContent = `R${r.raceNumber || r.id}: ${r.title}`;
    el.onclick = () => selectRace(r);
    list.appendChild(el);
  });
  document.getElementById('raceSelector').classList.remove('hidden');
}

function selectRace(r) {
  R = r;
  document.getElementById('raceSelector').classList.add('hidden');
  document.getElementById('raceTitle').textContent = r.title;
  document.getElementById('raceInfo').textContent = `${r.distance} ${r.surface}`;
  const list = document.getElementById('horseList');
  list.innerHTML = '';
  P.clear();
  r.horses.forEach(h => {
    const el = document.createElement('div');
    el.textContent = `#${h.number} ${h.name}`;
    el.onclick = () => toggleHorse(h.number, el);
    list.appendChild(el);
  });
  document.getElementById('raceDetail').classList.remove('hidden');
}

function toggleHorse(n, el) {
  if (P.has(n)) {
    P.delete(n);
    el.classList.remove('selected');
  } else {
    if (P.size >= 3) {
      alert('Max 3 horses');
      return;
    }
    P.add(n);
    el.classList.add('selected');
  }
  document.getElementById('savePicksBtn').disabled = !P.size;
}

async function savePicks() {
  if (!P.size) return;
  try {
    await fetch(`${API}/picks`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ session_code: S, race_id: R.id, user_name: U, horse_numbers: Array.from(P), user_color: '#ff4081' })
    });
    alert('Saved!');
  } catch (e) {
    alert(e.message);
  }
}

function backToDateSelector() {
  document.getElementById('trackSelector').classList.add('hidden');
  document.getElementById('dateSelector').classList.remove('hidden');
}
function backToTrackSelector() {
  document.getElementById('raceSelector').classList.add('hidden');
  document.getElementById('trackSelector').classList.remove('hidden');
}
function backToRaceSelector() {
  document.getElementById('raceDetail').classList.add('hidden');
  document.getElementById('raceSelector').classList.remove('hidden');
}
function goHome() { location.reload(); }
</script>
</body>
</html>
