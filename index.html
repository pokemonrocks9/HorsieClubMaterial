<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#1a1110">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Horsie Picker">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>Horsie Picker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #1a1110;
            color: #f0dedd;
            min-height: 100vh;
            padding: 16px;
            transition: background 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        }
        
        .container { max-width: 1200px; margin: 0 auto; }
        
        .header { 
            background: #2d1f1e;
            padding: 24px;
            border-radius: 28px;
            margin-bottom: 24px;
            box-shadow: 0px 1px 2px rgba(0, 0, 0, 0.3), 0px 2px 6px 2px rgba(0, 0, 0, 0.15);
            border: 1px solid #534341;
        }
        
        h1 { 
            color: var(--theme-color, #f44336);
            margin-bottom: 8px;
            font-size: 32px;
            font-weight: 400;
            transition: color 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        }
        
        .subtitle { color: #d8c2bf; font-size: 14px; }
        
        .setup-section, .selector-section, .race-detail { 
            background: #2d1f1e;
            padding: 24px;
            border-radius: 28px;
            margin-bottom: 16px;
            box-shadow: 0px 1px 2px rgba(0, 0, 0, 0.3), 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
            border: 1px solid #534341;
        }
        
        .input-group { margin-bottom: 24px; }
        label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 14px; color: #d8c2bf; }
        
        input[type="text"], select { 
            width: 100%;
            padding: 16px;
            border: 1px solid #a08c8a;
            border-radius: 12px;
            font-size: 16px;
            font-family: 'Roboto', sans-serif;
            background: #534341;
            color: #f0dedd;
            transition: all 0.2s cubic-bezier(0.4, 0.0, 0.2, 1);
        }
        
        input[type="text"]:focus, select:focus { 
            outline: none;
            border: 2px solid var(--theme-color, #f44336);
            padding: 15px;
            background: #2d1f1e;
        }
        
        .btn { 
            background: var(--theme-color, #f44336);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 100px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0.0, 0.2, 1);
            box-shadow: 0px 1px 2px rgba(0, 0, 0, 0.3), 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
            font-family: 'Roboto', sans-serif;
        }
        
        .btn:hover { box-shadow: 0px 1px 2px rgba(0, 0, 0, 0.3), 0px 2px 6px 2px rgba(0, 0, 0, 0.15); }
        .btn:active { box-shadow: 0px 1px 2px rgba(0, 0, 0, 0.3), 0px 1px 3px 1px rgba(0, 0, 0, 0.15); transform: scale(0.98); }
        .btn:disabled { background: #d8c2bf; opacity: 0.38; cursor: not-allowed; box-shadow: none; }
        
        .selector-grid { display: flex; flex-direction: column; gap: 12px; margin: 24px 0; }
        
        .selector-card { 
            border: 1px solid #534341;
            border-radius: 16px;
            padding: 16px 20px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0.0, 0.2, 1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            background: #2d1f1e;
        }
        
        .selector-card:hover { 
            background: #3a1411;
            border-color: var(--theme-color, #f44336);
            box-shadow: 0px 1px 2px rgba(0, 0, 0, 0.3), 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
        }
        
        .selector-card.has-picks { border-color: #4caf50; background: rgba(76, 175, 80, 0.08); }
        .selector-card.has-picks::after { content: '‚úì'; position: absolute; top: 8px; right: 12px; color: #4caf50; font-weight: 500; font-size: 16px; }
        
        .date-info { display: flex; align-items: center; gap: 16px; }
        .date-badge { font-size: 20px; font-weight: 500; color: #f0dedd; min-width: 80px; }
        .day-name { font-size: 16px; color: #d8c2bf; min-width: 50px; }
        .race-count { font-size: 14px; color: #d8c2bf; }
        
        .track-selector-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin: 24px 0; }
        
        .track-card { 
            border: 1px solid #534341;
            border-radius: 20px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0.0, 0.2, 1);
            text-align: center;
            position: relative;
            background: #2d1f1e;
        }
        
        .track-card:hover { 
            background: #3a1411;
            border-color: var(--theme-color, #f44336);
            box-shadow: 0px 1px 2px rgba(0, 0, 0, 0.3), 0px 2px 6px 2px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }
        
        .track-card.has-picks { border-color: #4caf50; background: rgba(76, 175, 80, 0.08); }
        .track-card.has-picks::after { content: '‚úì'; position: absolute; top: 8px; right: 12px; color: #4caf50; font-weight: 500; font-size: 16px; }
        .track-name { font-size: 20px; font-weight: 500; color: var(--theme-color, #f44336); transition: color 0.3s cubic-bezier(0.4, 0.0, 0.2, 1); }
        
        .color-picker-section { margin: 24px 0; padding: 20px; background: #534341; border-radius: 20px; }
        .color-picker-section h3 { color: #f0dedd; font-weight: 500; font-size: 16px; margin-bottom: 16px; }
        .color-options { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 16px; }
        
        .color-option { 
            width: 48px;
            height: 48px;
            border-radius: 24px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s cubic-bezier(0.4, 0.0, 0.2, 1);
            box-shadow: 0px 1px 2px rgba(0, 0, 0, 0.3), 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
        }
        
        .color-option:hover { transform: scale(1.1); box-shadow: 0px 1px 2px rgba(0, 0, 0, 0.3), 0px 2px 6px 2px rgba(0, 0, 0, 0.15); }
        .color-option.selected { border-color: #f0dedd; transform: scale(1.15); box-shadow: 0px 4px 8px 3px rgba(0, 0, 0, 0.15), 0px 1px 3px rgba(0, 0, 0, 0.3); }
        
        .race-list { display: grid; gap: 12px; margin: 24px 0; }
        
        .race-card { 
            border: 1px solid #534341;
            border-radius: 20px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0.0, 0.2, 1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            background: #2d1f1e;
        }
        
        .race-card:hover { 
            background: #3a1411;
            border-color: var(--theme-color, #f44336);
            box-shadow: 0px 1px 2px rgba(0, 0, 0, 0.3), 0px 2px 6px 2px rgba(0, 0, 0, 0.15);
        }
        
        .race-card.has-picks { border-color: #4caf50; background: rgba(76, 175, 80, 0.08); }
        .race-card.has-picks::after { content: '‚úì'; position: absolute; top: 8px; right: 12px; color: #4caf50; font-weight: 500; font-size: 16px; }
        
        .race-info { flex: 1; }
        .race-number { font-size: 24px; font-weight: 500; color: var(--theme-color, #f44336); margin-right: 16px; transition: color 0.3s cubic-bezier(0.4, 0.0, 0.2, 1); }
        .race-title { font-size: 18px; font-weight: 500; color: #f0dedd; margin-bottom: 4px; }
        .race-details { font-size: 14px; color: #d8c2bf; }
        .grade-badge { display: inline-block; background: #564400; color: #ffebb4; padding: 4px 12px; border-radius: 8px; font-size: 12px; font-weight: 500; margin-left: 8px; }
        
        .horse-list { display: flex; flex-direction: column; gap: 12px; margin: 24px 0; }
        
        .horse-card { 
            border: 2px solid #534341;
            border-radius: 16px;
            padding: 16px 20px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0.0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 16px;
            position: relative;
            background: #2d1f1e;
        }
        
        .horse-card.gradient-border::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 16px;
            padding: 2px;
            background: var(--gradient-border);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            pointer-events: none;
        }
        
        .horse-card:hover { background: #3a1411; border-color: var(--theme-color, #f44336); box-shadow: 0px 1px 2px rgba(0, 0, 0, 0.3), 0px 1px 3px 1px rgba(0, 0, 0, 0.15); }
        .horse-card.selected { border-color: var(--theme-color, #f44336); background: #3a1411; box-shadow: 0px 1px 2px rgba(0, 0, 0, 0.3), 0px 2px 6px 2px rgba(0, 0, 0, 0.15); }
        
        .horse-number { font-size: 20px; font-weight: 500; min-width: 40px; color: #d8c2bf; transition: color 0.3s cubic-bezier(0.4, 0.0, 0.2, 1); }
        .horse-name { font-size: 16px; flex: 1; color: #f0dedd; }
        .horse-card.selected .horse-name { font-weight: 500; color: var(--theme-color, #f44336); }
        .horse-card.selected .horse-number { color: var(--theme-color, #f44336); }
        
        .picker-badge { 
            position: static;
            padding: 0;
            border-radius: 50%;
            font-size: 14px;
            font-weight: 500;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            box-shadow: 0px 1px 2px rgba(0, 0, 0, 0.3), 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
        }
        
        .action-buttons { display: flex; gap: 12px; margin-top: 24px; flex-wrap: wrap; }
        .back-btn { background: #5d3f3b; color: #ffdad5; }
        .back-btn:hover { background: #6d4f4b; }
        .hidden { display: none; }
        .info-box { background: #3a1411; border-left: 4px solid var(--theme-color, #f44336); padding: 16px; margin: 20px 0; border-radius: 12px; color: #ffdad5; font-size: 14px; }
        .breadcrumb { font-size: 14px; color: #d8c2bf; margin-bottom: 20px; }
        .breadcrumb a { color: var(--theme-color, #f44336); text-decoration: none; cursor: pointer; transition: color 0.2s cubic-bezier(0.4, 0.0, 0.2, 1); font-weight: 500; }
        .breadcrumb a:hover { text-decoration: underline; }
        
        h2, h3 { font-weight: 400; color: #f0dedd; margin-bottom: 16px; }
        h2 { font-size: 24px; }
        h3 { font-size: 20px; }
        
        ::-webkit-scrollbar { width: 12px; }
        ::-webkit-scrollbar-track { background: #534341; border-radius: 6px; }
        ::-webkit-scrollbar-thumb { background: #a08c8a; border-radius: 6px; }
        ::-webkit-scrollbar-thumb:hover { background: #d8c2bf; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1 id="headerTitle">üèá Horsie Picker</h1>
                    <p class="subtitle">Choose the horses you think will win, spoiler free!</p>
                </div>
                <div style="display: flex; flex-direction: column; gap: 10px; align-items: stretch;">
                    <button id="backToHomeBtn" class="btn back-btn hidden" onclick="backToHome()">üè† Home</button>
                    <a href="https://jra.jp/JRAEN/AP/common/main" target="_blank" style="text-decoration: none;">
                        <button class="btn" style="white-space: nowrap; width: 100%;">üì∫ Watch JRA Races</button>
                    </a>
                </div>
            </div>
        </div>

        <div id="setup" class="setup-section">
            <h2>Setup Session</h2>
            <div class="info-box">üéØ Enter your details to get started!</div>
            
            <div style="margin: 20px 0; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                <h3 style="margin-bottom: 10px;">Active Sessions</h3>
                <div id="activeSessions" style="max-height: 200px; overflow-y: auto;">
                    <p style="color: #666;">Loading sessions...</p>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="btn" onclick="refreshSessions()">üîÑ Refresh</button>
                    <button class="btn" onclick="clearAllSessions()" style="background: #f44336;">üóëÔ∏è Clear All</button>
                </div>
            </div>
            
            <div class="color-picker-section">
                <h3 style="margin-bottom: 10px;">Choose Your Color</h3>
                <div class="color-options" id="colorOptions">
                    <div class="color-option selected" style="background: #f44336;" data-color="#f44336" onclick="selectColor('#f44336')"></div>
                    <div class="color-option" style="background: #ff5722;" data-color="#ff5722" onclick="selectColor('#ff5722')"></div>
                    <div class="color-option" style="background: #ff9800;" data-color="#ff9800" onclick="selectColor('#ff9800')"></div>
                    <div class="color-option" style="background: #ffc107;" data-color="#ffc107" onclick="selectColor('#ffc107')"></div>
                    <div class="color-option" style="background: #4caf50;" data-color="#4caf50" onclick="selectColor('#4caf50')"></div>
                    <div class="color-option" style="background: #2196f3;" data-color="#2196f3" onclick="selectColor('#2196f3')"></div>
                    <div class="color-option" style="background: #3f51b5;" data-color="#3f51b5" onclick="selectColor('#3f51b5')"></div>
                    <div class="color-option" style="background: #9c27b0;" data-color="#9c27b0" onclick="selectColor('#9c27b0')"></div>
                    <div class="color-option" style="background: #e91e63;" data-color="#e91e63" onclick="selectColor('#e91e63')"></div>
                    <div class="color-option" style="background: #795548;" data-color="#795548" onclick="selectColor('#795548')"></div>
                </div>
            </div>
            
            <div class="input-group">
                <label for="username">Your Name:</label>
                <input type="text" id="username" placeholder="Enter your name">
            </div>
            <div class="input-group">
                <label for="sessionCode">Session Code:</label>
                <input type="text" id="sessionCode" placeholder="Create or join a session">
            </div>
            <button class="btn" id="sessionBtn" onclick="joinSession()">Create Session</button>
        </div>

        <div id="dateSelector" class="selector-section hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Select a Race Day</h2>
                <button class="btn" onclick="refreshRaces()">üîÑ Refresh Races</button>
            </div>
            <div class="selector-grid" id="dateGrid"></div>
        </div>

        <div id="trackSelector" class="selector-section hidden">
            <button class="btn back-btn" onclick="backToDateSelector()">‚Üê Back to Dates</button>
            <h2 id="selectedDateTitle" style="margin-top: 15px;"></h2>
            <div class="track-selector-grid" id="trackGrid"></div>
        </div>

        <div id="raceSelector" class="selector-section hidden">
            <button class="btn back-btn" onclick="backToTrackSelector()">‚Üê Back to Tracks</button>
            <h2 id="selectedTrackTitle" style="margin-top: 15px;"></h2>
            <div class="race-list" id="raceList"></div>
        </div>

        <div id="raceDetail" class="race-detail hidden">
            <button class="btn back-btn" onclick="backToRaceSelector()">‚Üê Back to Races</button>
            <h2 id="selectedRaceTitle" style="margin-top: 15px;"></h2>
            <p id="selectedRaceInfo"></p>
            <div class="info-box">Pick your horse(s) below. Picks update automatically every 3 seconds!</div>
            <div class="horse-list" id="horseList"></div>
            <div class="action-buttons">
                <button class="btn" id="confirmPickBtn" onclick="confirmPicks()" disabled>Confirm My Picks</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>
let U='',S='',C='#f44336',D='',T='',R=null,P=new Set(),races=[],poll=null,allSessionPicks=[];const API='https://horsie.tytygoins.workers.dev',RACES='https://raw.githubusercontent.com/pokemonrocks9/HorsieClub/main/races.json';

function selectColor(c){
    C=c;
    document.querySelectorAll('.color-option').forEach(e=>{
        e.classList.remove('selected');
        e.dataset.color===c&&e.classList.add('selected')
    });
    localStorage.setItem('userColor',c);
    applyTheme(c);
}

function applyTheme(c){
    const darker=darkenColor(c,0.15),darkest=darkenColor(c,0.25),lighter=lightenColor(c,0.9);
    document.documentElement.style.setProperty('--theme-color',c);
    document.body.style.background=`linear-gradient(135deg, ${darker} 0%, ${darkest} 100%)`;
    document.querySelectorAll('h1, .track-name, .race-number, .horse-number, .breadcrumb a').forEach(e=>e.style.color=c);
    document.querySelectorAll('.btn:not([style*="background: #f44336"])').forEach(e=>{
        e.style.background=c;
        e.onmouseenter=()=>e.style.background=darker;
        e.onmouseleave=()=>e.style.background=c
    });
    document.querySelectorAll('input:focus, select:focus').forEach(e=>e.style.borderColor=c);
    document.querySelectorAll('.horse-card.selected').forEach(e=>{
        e.style.borderColor=c;
        e.style.background=lighter
    });
}

function darkenColor(hex,amt){
    let r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);
    r=Math.max(0,Math.floor(r*(1-amt)));
    g=Math.max(0,Math.floor(g*(1-amt)));
    b=Math.max(0,Math.floor(b*(1-amt)));
    return`#${r.toString(16).padStart(2,'0')}${g.toString(16).padStart(2,'0')}${b.toString(16).padStart(2,'0')}`;
}

function lightenColor(hex,amt){
    let r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);
    r=Math.min(255,Math.floor(r+(255-r)*amt));
    g=Math.min(255,Math.floor(g+(255-g)*amt));
    b=Math.min(255,Math.floor(b+(255-b)*amt));
    return`#${r.toString(16).padStart(2,'0')}${g.toString(16).padStart(2,'0')}${b.toString(16).padStart(2,'0')}`;
}

window.addEventListener('DOMContentLoaded',async()=>{
    const c=localStorage.getItem('userColor');
    c?(selectColor(c),applyTheme(c)):applyTheme('#f44336');
    await autoClean();
    refreshSessions();
    document.getElementById('sessionCode').addEventListener('input',updateBtn);
});

async function autoClean(){
    try{
        await fetch(`${API}/picks/old`,{method:'DELETE'});
        console.log('‚úÖ Cleaned');
    }catch(e){}
}

async function loadAllSessionPicks(){
    if(!S)return;
    try{
        const r=await fetch(`${API}/picks?session=${S}`);
        if(r.ok){
            const data=await r.json();
            allSessionPicks=data;
            console.log(`Loaded ${allSessionPicks.length} total picks for session`);
        }else{
            allSessionPicks=[];
        }
    }catch(e){
        allSessionPicks=[];
    }
}

function hasPicksForDate(date){
    return allSessionPicks.some(p=>races.find(r=>r.id===p.race_id&&r.date===date));
}

function hasPicksForTrack(track){
    return allSessionPicks.some(p=>races.find(r=>r.id===p.race_id&&r.track===track&&r.date===D));
}

function hasPicksForRace(raceId){
    return allSessionPicks.some(p=>p.race_id===raceId);
}

async function refreshSessions(){
    const e=document.getElementById('activeSessions');
    e.innerHTML='<p style="color:#666;">Loading...</p>';
    try{
        const r=await fetch(`${API}/picks/sessions`);
        if(!r.ok){
            e.innerHTML='<p style="color:#666;">API unavailable</p>';
            return;
        }
        const d=await r.json(),s={};
        d.forEach(p=>{
            s[p.session_code]||(s[p.session_code]={users:new Set,lastActivity:p.created_at,count:0});
            s[p.session_code].users.add(p.user_name);
            s[p.session_code].count++;
        });
        if(Object.keys(s).length===0){
            e.innerHTML='<p style="color:#666;">No active sessions</p>';
        }else{
            let h='<div style="display:flex;flex-direction:column;gap:10px;">';
            for(const[c,i]of Object.entries(s)){
                const u=Array.from(i.users).join(', '),t=getTimeAgo(new Date(i.lastActivity));
                h+=`<div style="padding:10px;border:1px solid #e0e0e0;border-radius:5px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'"><div onclick="joinExistingSession('${c}')" style="flex:1;"><strong>${c}</strong><br><small style="color:#666;">Users: ${u} ‚Ä¢ ${i.count} picks ‚Ä¢ ${t}</small></div><button onclick="event.stopPropagation();deleteSession('${c}')" style="background:#f44336;color:white;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;font-size:12px;">Delete</button></div>`;
            }
            h+='</div>';
            e.innerHTML=h;
        }
    }catch(err){
        e.innerHTML='<p style="color:#666;">API unavailable</p>';
    }
}

function joinExistingSession(c){
    document.getElementById('sessionCode').value=c;
    updateBtn();
}

function updateBtn(){
    const c=document.getElementById('sessionCode').value.trim(),b=document.getElementById('sessionBtn'),a=document.querySelectorAll('#activeSessions strong');
    let e=false;
    a.forEach(el=>{
        el.textContent===c&&(e=true);
    });
    b.textContent=e?'Join Session':'Create Session';
}

function getTimeAgo(d){
    const s=Math.floor((new Date-d)/1000);
    if(s<60)return'just now';
    const m=Math.floor(s/60);
    if(m<60)return`${m}m ago`;
    const h=Math.floor(m/60);
    if(h<24)return`${h}h ago`;
    return`${Math.floor(h/24)}d ago`;
}

async function deleteSession(c){
    if(!confirm(`Delete "${c}"?`))return;
    try{
        if(!(await fetch(`${API}/picks/${c}`,{method:'DELETE'})).ok)return;
        alert(`‚úÖ Deleted "${c}"!`);
        await new Promise(r=>setTimeout(r,1000));
        await refreshSessions();
    }catch(e){
        alert(`Error: ${e.message}`);
    }
}

async function clearAllSessions(){
    if(!confirm('‚ö†Ô∏è Delete ALL?'))return;
    if(!confirm('Really sure?'))return;
    try{
        if(!(await fetch(`${API}/picks/all`,{method:'DELETE'})).ok)return;
        localStorage.clear();
        alert('‚úÖ ALL deleted!');
        await new Promise(r=>setTimeout(r,1000));
        await refreshSessions();
    }catch(e){
        alert(`Error: ${e.message}`);
    }
}

async function joinSession(){
    const u=document.getElementById('username').value.trim(),s=document.getElementById('sessionCode').value.trim();
    if(!u||!s){
        alert('Enter both!');
        return;
    }
    U=u;
    S=s;
    document.getElementById('setup').classList.add('hidden');
    await loadRaces();
    await loadAllSessionPicks();
    showDateSelector();
}

async function loadRaces(){
    try{
        races=await(await fetch(RACES)).json();
    }catch(e){
        alert('Error loading races');
    }
}

async function refreshRaces(){
    await loadRaces();
    document.getElementById('trackSelector').classList.add('hidden');
    document.getElementById('raceSelector').classList.add('hidden');
    document.getElementById('raceDetail').classList.add('hidden');
    showDateSelector();
    alert(`Loaded ${races.length} races`);
}

function showDateSelector(){
    document.getElementById('headerTitle').textContent='üèá Select a Race Day';
    document.getElementById('backToHomeBtn').classList.remove('hidden');
    const byDate={};
    races.forEach(r=>{
        r.date&&(byDate[r.date]||(byDate[r.date]=[]),byDate[r.date].push(r));
    });
    const g=document.getElementById('dateGrid');
    g.innerHTML='';
    Object.keys(byDate).sort((a,b)=>new Date(a)-new Date(b)).forEach(d=>{
        const dt=new Date(d+'T00:00:00'),day=dt.toLocaleDateString('en-US',{weekday:'short'}),str=dt.toLocaleDateString('en-US',{month:'short',day:'numeric'}),c=document.createElement('div');
        c.className='selector-card';
        if(hasPicksForDate(d))c.classList.add('has-picks');
        c.onclick=()=>selectDate(d);
        c.innerHTML=`<div class="date-info"><div class="date-badge">${str}</div><div class="day-name">${day}</div></div><div class="race-count">${byDate[d].length} races</div>`;
        g.appendChild(c);
    });
    document.getElementById('dateSelector').classList.remove('hidden');
}

function selectDate(d){
    D=d;
    document.getElementById('dateSelector').classList.add('hidden');
    showTrackSelector();
}

function showTrackSelector(){
    document.getElementById('headerTitle').textContent='üèá Select a Track';
    const byTrack={};
    races.filter(r=>r.date===D).forEach(r=>{
        byTrack[r.track]||(byTrack[r.track]=[]);
        byTrack[r.track].push(r);
    });
    const [y,m,d]=D.split('-');
    const dateObj=new Date(y,m-1,d);
    document.getElementById('selectedDateTitle').textContent=dateObj.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'});
    const g=document.getElementById('trackGrid');
    g.innerHTML='';
    Object.keys(byTrack).sort().forEach(t=>{
        const c=document.createElement('div');
        c.className='track-card';
        if(hasPicksForTrack(t))c.classList.add('has-picks');
        c.onclick=()=>selectTrack(t);
        c.innerHTML=`<div class="track-name">${t}</div><div class="race-count">${byTrack[t].length} races</div>`;
        g.appendChild(c);
    });
    document.getElementById('trackSelector').classList.remove('hidden');
}

function selectTrack(t){
    T=t;
    document.getElementById('trackSelector').classList.add('hidden');
    showRaceSelector();
}

function showRaceSelector(){
    document.getElementById('headerTitle').textContent='üèá Select a Race';
    const rs=races.filter(r=>r.date===D&&r.track===T);
    rs.sort((a,b)=>(a.raceNumber||a.id)-(b.raceNumber||b.id));
    document.getElementById('selectedTrackTitle').textContent=`${T} - ${new Date(D).toLocaleDateString('en-US',{month:'short',day:'numeric'})}`;
    const l=document.getElementById('raceList');
    l.innerHTML='';
    rs.forEach(r=>{
        const c=document.createElement('div');
        c.className='race-card';
        if(hasPicksForRace(r.id))c.classList.add('has-picks');
        c.onclick=()=>selectRace(r);
        const g=r.grade?`<span class="grade-badge">${r.grade}</span>`:'',n=r.raceNumber||r.id;
        c.innerHTML=`<div class="race-number">R${n}</div><div class="race-info"><div class="race-title">${r.title} ${g}</div><div class="race-details">${r.distance} ${r.surface} - ${r.horses.length} horses</div></div>`;
        l.appendChild(c);
    });
    document.getElementById('raceSelector').classList.remove('hidden');
}

function selectRace(r){
    document.getElementById('headerTitle').textContent='üèá Pick Your Horses';
    R=r;
    P.clear();
    document.getElementById('raceSelector').classList.add('hidden');
    const g=r.grade?`<span class="grade-badge">${r.grade}</span>`:'';
    document.getElementById('selectedRaceTitle').innerHTML=`${r.title} ${g}`;
    document.getElementById('selectedRaceInfo').textContent=`${r.track} - ${r.distance} ${r.surface}`;
    loadHorses(r);
    document.getElementById('raceDetail').classList.remove('hidden');
    startPoll();
}

function startPoll(){
    stopPoll();
    poll=setInterval(()=>{
        R&&loadExistingPicks();
    },3000);
}

function stopPoll(){
    poll&&(clearInterval(poll),poll=null);
}

function loadHorses(r){
    const l=document.getElementById('horseList');
    l.innerHTML='';
    [...r.horses].sort((a,b)=>a.number-b.number).forEach(h=>{
        const c=document.createElement('div');
        c.className='horse-card';
        c.onclick=()=>togglePick(h.number,c);
        c.innerHTML=`<div class="horse-number">#${h.number}</div><div class="horse-name">${h.name}</div>`;
        c.dataset.horseNumber=h.number;
        l.appendChild(c);
    });
    loadExistingPicks();
}

function togglePick(n,c){
    if(P.has(n)){
        P.delete(n);
        c.classList.remove('selected');
        c.style.background='';
    }else{
        P.add(n);
        c.classList.add('selected');
        c.style.background=`${C}15`;
    }
    updateButtons();
}

function updateButtons(){
    document.getElementById('confirmPickBtn').disabled=P.size===0;
}

async function confirmPicks(){
    if(P.size===0)return;
    const data={user:U,raceId:R.id,horses:Array.from(P),color:C,timestamp:new Date().toISOString()};
    try{
        await fetch(`${API}/picks`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({session_code:S,race_id:R.id,user_name:U,horse_numbers:Array.from(P),user_color:C})});
    }catch(e){}
    localStorage.setItem(`${S}_${R.id}_${U}`,JSON.stringify(data));
    localStorage.setItem(`${S}_${R.id}_confirmed`,'true');
    const names=Array.from(P).map(n=>`#${n} ${R.horses.find(h=>h.number===n).name}`).join(', ');
    alert(`‚úÖ Picks confirmed!\n\nYou chose: ${names}`);
    await loadAllSessionPicks();
    loadExistingPicks();
    updateButtons();
}

async function loadExistingPicks(){
    const picks={},colors={};
    try{
        const r=await fetch(`${API}/picks?session=${S}&race=${R.id}`);
        if(r.ok)(await r.json()).forEach(p=>{
            picks[p.user_name]=JSON.parse(p.horse_numbers);
            p.user_color&&(colors[p.user_name]=p.user_color);
        });
    }catch(e){}
    for(let i=0;i<localStorage.length;i++){
        const k=localStorage.key(i);
        if(k&&k.startsWith(`${S}_${R.id}_`)&&!k.endsWith('_confirmed')){
            const u=k.split('_').pop();
            if(!picks[u]){
                const d=JSON.parse(localStorage.getItem(k));
                picks[u]=d.horses;
                d.color&&(colors[u]=d.color);
            }
        }
    }
    colors[U]=C;
    
    // Remove all badges first
    document.querySelectorAll('.picker-badge').forEach(b=>b.remove());
    document.querySelectorAll('.picked-by-user2').forEach(c=>c.classList.remove('picked-by-user2'));
    
    // Reset all backgrounds and borders
    document.querySelectorAll('.horse-card').forEach(c=>{
        c.style.background='';
        c.style.backgroundImage='';
        c.style.backgroundOrigin='';
        c.style.backgroundClip='';
        c.style.border='';
        if(!c.classList.contains('selected')){
            c.style.border='2px solid #e0e0e0';
        }
    });
    
    // Track horses picked by multiple users
    const horsePickCounts={};
    Object.entries(picks).forEach(([u,hs])=>{
        hs.forEach(n=>{
            if(!horsePickCounts[n])horsePickCounts[n]=[];
            horsePickCounts[n].push({user:u,color:colors[u]||(u===U?C:'#ff9800')});
        });
    });
    
    // Add badges for all picks
    Object.entries(picks).forEach(([u,hs])=>{
        const col=colors[u]||(u===U?C:'#ff9800'),init=u.charAt(0).toUpperCase();
        hs.forEach(n=>{
            const c=document.querySelector(`[data-horse-number="${n}"]`);
            if(c){
                const b=document.createElement('div');
                b.className='picker-badge';
                b.style.background=col;
                b.textContent=init;
                b.title=u;
                c.appendChild(b);
                u!==U&&c.classList.add('picked-by-user2');
            }
        });
    });
    
    // Apply gradients after all badges are added
    Object.keys(horsePickCounts).forEach(n=>{
        const c=document.querySelector(`[data-horse-number="${n}"]`);
        const pickerData=horsePickCounts[n];
        if(c&&pickerData.length>1){
            // Multiple pickers - create smooth gradient with blended colors (lighter)
            const bgGradientStops=pickerData.map((data,i)=>{
                const pct=(i/(pickerData.length-1))*100;
                return `${data.color}15 ${pct}%`;
            }).join(', ');
            
            const borderGradientStops=pickerData.map((data,i)=>{
                const pct=(i/(pickerData.length-1))*100;
                return `${data.color} ${pct}%`;
            }).join(', ');
            
            // Set light background gradient
            c.style.background=`linear-gradient(90deg, ${bgGradientStops})`;
            
            // Use pseudo-element trick for rounded gradient border
            c.style.position='relative';
            c.style.background=`linear-gradient(90deg, ${bgGradientStops})`;
            c.style.border='none';
            c.style.setProperty('--gradient-border', `linear-gradient(90deg, ${borderGradientStops})`);
            
            // Add class to trigger pseudo-element
            c.classList.add('gradient-border');
        } else if(c&&pickerData.length===1){
            // Single picker - show their color with light background and solid border
            c.classList.remove('gradient-border');
            const pickerColor=pickerData[0].color;
            if(!P.has(parseInt(n))){
                // Not selected by current user - show other person's pick
                c.style.background=`${pickerColor}15`;
                c.style.border=`2px solid ${pickerColor}`;
            } else {
                // Selected by current user
                c.style.background=`${C}15`;
            }
        }
    });
}

function backToHome(){
    stopPoll();
    document.getElementById('trackSelector').classList.add('hidden');
    document.getElementById('raceSelector').classList.add('hidden');
    document.getElementById('raceDetail').classList.add('hidden');
    showDateSelector();
}

function backToDateSelector(){
    stopPoll();
    document.getElementById('trackSelector').classList.add('hidden');
    document.getElementById('raceSelector').classList.add('hidden');
    document.getElementById('raceDetail').classList.add('hidden');
    showDateSelector();
}

function backToTrackSelector(){
    stopPoll();
    document.getElementById('raceSelector').classList.add('hidden');
    document.getElementById('raceDetail').classList.add('hidden');
    showTrackSelector();
}

function backToRaceSelector(){
    stopPoll();
    document.getElementById('raceDetail').classList.add('hidden');
    showRaceSelector();
}
    </script>
</body>
</html>
    <script>
    // Register service worker for PWA
    if('serviceWorker' in navigator){
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('service-worker.js')
                .then(reg=>console.log('Service Worker registered'))
                .catch(err=>console.log('Service Worker registration failed',err));
        });
    }
    </script>
</body>
</html>
